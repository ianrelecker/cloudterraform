-- Simplified CVE Processor Database Schema
-- Compatible with Azure Functions implementation

-- Drop existing tables
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'SOC_Reports')
    DROP TABLE SOC_Reports;
GO

IF EXISTS (SELECT * FROM sys.tables WHERE name = 'CVEs')
    DROP TABLE CVEs;
GO

-- Create CVEs table
CREATE TABLE CVEs (
    CVE_ID NVARCHAR(50) NOT NULL,
    Description NVARCHAR(MAX) NOT NULL,
    Severity NVARCHAR(20),
    CVSS_Score DECIMAL(3,1),
    Published_Date DATETIME2,
    Modified_Date DATETIME2,
    Created_At DATETIME2 DEFAULT GETUTCDATE(),
    CONSTRAINT PK_CVEs PRIMARY KEY (CVE_ID)
);
GO

-- Create SOC_Reports table
CREATE TABLE SOC_Reports (
    Report_ID UNIQUEIDENTIFIER NOT NULL DEFAULT NEWID(),
    CVE_ID NVARCHAR(50) NOT NULL,
    SOC_Analysis NVARCHAR(MAX),
    Analysis_Date DATETIME2 DEFAULT GETUTCDATE(),
    AI_Model_Used NVARCHAR(100),
    CONSTRAINT PK_SOC_Reports PRIMARY KEY (Report_ID),
    CONSTRAINT FK_SOC_Reports_CVE FOREIGN KEY (CVE_ID) REFERENCES CVEs(CVE_ID) ON DELETE CASCADE
);
GO

-- Create indexes for performance
CREATE INDEX IX_CVEs_Published_Date ON CVEs(Published_Date DESC);
CREATE INDEX IX_CVEs_Severity ON CVEs(Severity);
CREATE INDEX IX_SOC_Reports_CVE_ID ON SOC_Reports(CVE_ID);
CREATE INDEX IX_SOC_Reports_Analysis_Date ON SOC_Reports(Analysis_Date DESC);
GO

-- Insert sample data
INSERT INTO CVEs (CVE_ID, Description, Severity, CVSS_Score, Published_Date, Modified_Date)
VALUES 
('CVE-2025-0001', 'Critical remote code execution vulnerability in popular web framework allowing unauthenticated attackers to execute arbitrary code on affected systems', 'CRITICAL', 9.8, GETUTCDATE(), GETUTCDATE()),
('CVE-2025-0002', 'High severity SQL injection vulnerability in database management interface enabling privilege escalation attacks', 'HIGH', 7.5, DATEADD(hour, -2, GETUTCDATE()), DATEADD(hour, -2, GETUTCDATE())),
('CVE-2025-0003', 'Medium severity cross-site scripting vulnerability in user profile management system', 'MEDIUM', 5.3, DATEADD(hour, -4, GETUTCDATE()), DATEADD(hour, -4, GETUTCDATE()));
GO

-- Insert sample SOC analysis
INSERT INTO SOC_Reports (CVE_ID, SOC_Analysis, AI_Model_Used)
VALUES 
('CVE-2025-0002', 
'**Threat Assessment:** This SQL injection vulnerability presents a significant threat to database security with potential for complete database compromise.

**Impact Analysis:** Successful exploitation could lead to unauthorized data access, data modification, and potential system takeover in affected database environments.

**Recommended Actions:**
• Immediately patch all affected database management systems
• Review database access logs for suspicious activity
• Implement additional input validation and parameterized queries
• Consider temporary network segmentation for affected systems

**Priority Level:** HIGH - Immediate attention required due to ease of exploitation and significant potential impact on data confidentiality and integrity.', 
'claude-3-5-sonnet-20241022');
GO

PRINT 'Simplified database schema deployed successfully!';