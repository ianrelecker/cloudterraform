# CVE Processor - Simplified Azure Solution

**Automated CVE monitoring and SOC analysis powered by Azure Functions and Claude AI**

## üöÄ Quick Start

This solution has been completely simplified from the original Container Apps Environment approach to use Azure Functions for reliability and ease of deployment.

### Prerequisites

- Azure CLI
- Terraform >= 1.6.0  
- Node.js (for Azure Functions Core Tools)
- NVD API Key (optional but recommended)
- Claude API Key

### One-Command Deployment

```bash
./deploy.sh
```

The script will:
1. ‚úÖ Install Azure Functions Core Tools if needed
2. ‚úÖ Deploy infrastructure with Terraform
3. ‚úÖ Set up SQL Database with schema
4. ‚úÖ Deploy Azure Functions for automation
5. ‚úÖ Deploy web application
6. ‚úÖ Test the complete workflow

## üìã Architecture Overview

### Simplified Design

```
NVD API ‚Üí Azure Function (Timer) ‚Üí SQL Database ‚Üí Storage Queue
                                       ‚Üì              ‚Üì
                                  Web App ‚Üê Azure Function (Queue Trigger)
                                                      ‚Üì
                                              Claude API (SOC Analysis)
```

### Components

- **Azure Functions (Consumption Plan)**: Serverless execution without infrastructure management
- **Timer Function**: Fetches CVEs from NVD API every 2 hours
- **Queue Function**: Processes CVEs for SOC analysis using Claude AI
- **Azure SQL Database**: Stores CVE data and SOC reports
- **Azure App Service**: Web interface displaying CVE blog
- **Storage Queue**: Event-driven messaging between functions

## üîß Configuration

### 1. Create `terraform.tfvars`

```hcl
# Basic Configuration
prefix      = "cve-processor"
location    = "westus"
environment = "dev"

# API Keys
nvd_api_key    = "your-nvd-api-key"
claude_api_key = "your-claude-api-key"

# Database
sql_admin_username = "sqladmin"
sql_admin_password = "YourSecurePassword123!"
```

### 2. Run Deployment

```bash
az login
./deploy.sh
```

## üìä Features

### Automated Workflow
- **Every 2 hours**: NVD ingestion function fetches latest CVEs
- **Real-time**: SOC processor analyzes new CVEs using Claude AI
- **Automatic**: No manual intervention required

### Web Interface
- **CVE Blog Format**: Latest vulnerabilities displayed as blog posts
- **SOC Analysis**: AI-powered security analysis for each CVE
- **Severity Filtering**: Color-coded by CVSS severity
- **Statistics API**: `/stats` endpoint for monitoring

### Monitoring
- **Application Insights**: Built-in monitoring and alerts
- **Function Logs**: Real-time log streaming
- **Health Checks**: `/health` endpoint for status monitoring

## üõ† Manual Operations

### Test Functions
```bash
# Test NVD ingestion
az functionapp function start \
  --name cve-processor-dev-nvd-func \
  --resource-group cve-processor-dev-rg \
  --function-name "NVDIngestion"

# Monitor logs
az functionapp logs tail \
  --name cve-processor-dev-nvd-func \
  --resource-group cve-processor-dev-rg
```

### Database Access
```bash
# Get connection details
terraform output sql_server_fqdn
terraform output database_name

# Connect with Azure CLI
az sql db show-connection-string \
  --server cve-processor-dev-sqlserver \
  --name cve-processor-dev-db \
  --client sqlcmd
```

## üìà Cost Optimization

### Azure Functions Consumption Plan
- **1M free executions/month**
- **Pay-per-use**: Only charged when running
- **Estimated cost**: $5-15/month for typical CVE volumes

### Resource Optimization
- **SQL Database**: Serverless with auto-pause
- **App Service**: B1 tier for web interface
- **Storage**: LRS for cost efficiency

## üîí Security

### Secrets Management
- **Key Vault**: All API keys stored securely
- **Environment Variables**: Functions access secrets via app settings
- **SQL Authentication**: Azure AD integration enabled
- **TLS**: All connections encrypted

### Access Control
- **Firewall Rules**: SQL Server restricts access
- **Managed Identity**: Functions use managed identity where possible
- **HTTPS Only**: All web traffic encrypted

## üêõ Troubleshooting

### Common Issues

1. **Function deployment fails**
   ```bash
   # Check Function Core Tools version
   func --version  # Should be 4.x
   
   # Reinstall if needed
   npm install -g azure-functions-core-tools@4 --unsafe-perm true
   ```

2. **Database connection fails**
   ```bash
   # Check firewall rules
   az sql server firewall-rule list \
     --server cve-processor-dev-sqlserver \
     --resource-group cve-processor-dev-rg
   ```

3. **Web app not loading**
   ```bash
   # Check app logs
   az webapp log tail \
     --name cve-processor-dev-webapp \
     --resource-group cve-processor-dev-rg
   ```

### Log Monitoring
```bash
# Function logs
az functionapp logs tail --name cve-processor-dev-nvd-func --resource-group cve-processor-dev-rg

# Web app logs  
az webapp log tail --name cve-processor-dev-webapp --resource-group cve-processor-dev-rg
```

## üîÑ Maintenance

### Regular Tasks
- **Monitor costs**: Azure portal cost analysis
- **Review logs**: Check for errors in Application Insights
- **Update dependencies**: Keep Python packages current
- **Rotate secrets**: Update API keys periodically

### Scaling
- **Functions**: Auto-scale based on queue depth
- **Database**: Adjust serverless tier if needed
- **Web App**: Scale up App Service plan during high traffic

## üìù Development

### Local Testing
```bash
# Run functions locally
cd functions/nvd-ingestion
func start

cd ../soc-processor  
func start
```

### Database Schema Updates
```bash
# Apply schema changes
sqlcmd -S server-name -d database-name -U username -P password -i database/schema.sql
```

## üéØ Next Steps

1. **Monitor first run**: Check function logs after deployment
2. **Verify automation**: Confirm timer function runs every 2 hours
3. **Review results**: Visit web application to see CVE data
4. **Set up alerts**: Configure Application Insights alerts
5. **Customize analysis**: Modify SOC prompts for your needs

---

**üõ°Ô∏è This simplified solution eliminates Container Apps complexity while maintaining full automation and functionality.**