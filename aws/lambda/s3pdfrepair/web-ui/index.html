<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Repair</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s ease; }
        .upload-area:hover { border-color: #007bff; background-color: #f8f9fa; }
        .upload-area.dragover { border-color: #007bff; background-color: #e3f2fd; }
        #fileInput { display: none; }
        .btn { background-color: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn:hover { background-color: #0056b3; }
        .btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .progress { width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.3s ease; }
        .file-info { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .processed-files { margin-top: 30px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; margin: 10px 0; }
        .download-btn { background-color: #28a745; }
        .download-btn:hover { background-color: #1e7e34; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background-color: #cce7ff; color: #004085; border: 1px solid #b8daff; }
    </style>
    </head>
<body>
    <div class="container">
        <h1>PDF Repair</h1>
        <p>Upload your PDF files to repair structure, cross-reference tables, and metadata issues. Note: Original files can be deleted after processing (configurable), and old files are cleaned up automatically.</p>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div id="uploadText">
                <h3>Click to select PDF files or drag and drop them here</h3>
                <p>Supported format: PDF files up to 50MB</p>
            </div>
        </div>

        <input type="file" id="fileInput" accept=".pdf" multiple>

        <div id="uploadStatus" class="status" style="display: none;"></div>

        <div id="uploadProgress" class="progress" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="fileList"></div>

        <div class="processed-files">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Your Repaired Files</h3>
                <button class="btn" onclick="clearSession()" style="background-color: #6c757d; font-size: 14px; padding: 8px 16px;">Clear Session</button>
            </div>
            <div id="processedList">
                <p>No repaired files yet. Upload a PDF to get started!</p>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            S3_BUCKET: '${s3_bucket_name}',
            S3_REGION: '${region}',
            UPLOAD_FOLDER: '${upload_folder}',
            PROCESSED_FOLDER: '${processed_folder}',
            API_GATEWAY_URL: '${api_gateway_url}'
        };

        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const fileList = document.getElementById('fileList');
        const processedList = document.getElementById('processedList');

        let uploadedFiles = JSON.parse(sessionStorage.getItem('uploadedFiles') || '[]');

        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf'); handleFiles(files); });
        fileInput.addEventListener('change', (e) => { const files = Array.from(e.target.files); handleFiles(files); });

        function handleFiles(files) {
            if (files.length === 0) { showStatus('Please select at least one PDF file.', 'error'); return; }
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            if (pdfFiles.length !== files.length) { showStatus('Only PDF files are allowed.', 'error'); return; }
            const oversizedFiles = pdfFiles.filter(file => file.size > 50 * 1024 * 1024);
            if (oversizedFiles.length > 0) { showStatus('Some files are larger than 50MB limit.', 'error'); return; }
            displayFileList(pdfFiles); uploadFiles(pdfFiles);
        }

        function displayFileList(files) {
            fileList.innerHTML = '';
            files.forEach((file, index) => {
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                fileInfo.innerHTML = `
                    <div><strong>$${file.name}</strong></div>
                    <div>Size: $${formatFileSize(file.size)}</div>
                    <div id="status-$${index}">Preparing upload...</div>
                `;
                fileList.appendChild(fileInfo);
            });
        }

        async function uploadFiles(files) {
            showStatus('Uploading files...', 'info');
            uploadProgress.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const statusElement = document.getElementById(`status-$${i}`);
                try {
                    statusElement.textContent = 'Uploading...';
                    const formData = new FormData();
                    const fileName = file.name;
                    const s3Key = `$${CONFIG.UPLOAD_FOLDER}$${fileName}`;
                    await uploadToS3(file, s3Key, (progress) => {
                        const totalProgress = ((i + progress / 100) / files.length) * 100;
                        progressBar.style.width = `$${totalProgress}%`;
                    });
                    statusElement.innerHTML = '<span style="color: #28a745;">✓ Uploaded successfully</span>';
                    uploadedFiles.push({
                        originalName: fileName,
                        processedName: fileName.replace('.pdf', '_repaired.pdf'),
                        uploadTime: new Date().toISOString()
                    });
                    sessionStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                    statusElement.innerHTML = '<span style="color: #007bff;">Processing... (check back in a minute)</span>';
                } catch (error) {
                    statusElement.innerHTML = '<span style="color: #dc3545;">✗ Upload failed</span>';
                    console.error('Upload error:', error);
                }
            }

            progressBar.style.width = '100%';
            showStatus(`Successfully uploaded $${files.length} file(s). Processing will begin automatically.`, 'success');
            setTimeout(() => { uploadProgress.style.display = 'none'; progressBar.style.width = '0%'; fileList.innerHTML = ''; }, 3000);
        }

        async function uploadToS3(file, key, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => { if (e.lengthComputable) { const progress = (e.loaded / e.total) * 100; onProgress(progress); } });
                xhr.onload = function() { if (xhr.status === 200) { resolve(xhr.response); } else { reject(new Error(`Upload failed: $${xhr.status}`)); } };
                xhr.onerror = () => reject(new Error('Upload failed'));
                const url = `https://$${CONFIG.S3_BUCKET}.s3.$${CONFIG.S3_REGION}.amazonaws.com/$${key}`;
                xhr.open('PUT', url);
                xhr.setRequestHeader('Content-Type', 'application/pdf');
                xhr.send(file);
            });
        }

        async function refreshProcessedFiles() {
            if (uploadedFiles.length === 0) { processedList.innerHTML = '<p>No repaired files yet. Upload a PDF to get started!</p>'; return; }
            let html = '';
            uploadedFiles.forEach(file => {
                const uploadTime = new Date(file.uploadTime);
                const timeSinceUpload = (new Date() - uploadTime) / 1000;
                if (timeSinceUpload < 15) {
                    const secondsLeft = Math.max(0, 15 - Math.floor(timeSinceUpload));
                    html += `
                        <div class="file-item" style="opacity: 0.7;">
                            <div>
                                <strong>$${file.originalName}</strong><br>
                                <small>Repairing... (estimated $${secondsLeft}s remaining)</small>
                            </div>
                            <button class="btn" disabled>Processing...</button>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="file-item">
                            <div>
                                <strong>$${file.processedName}</strong><br>
                                <small>Processed from: $${file.originalName}</small>
                            </div>
                            <button class="btn download-btn" onclick="downloadFile('$${file.processedName}', this)">Download</button>
                        </div>
                    `;
                }
            });
            processedList.innerHTML = html;
        }

        function downloadFile(filename, buttonElement) {
            const downloadUrl = `$${CONFIG.API_GATEWAY_URL}/$${filename}`;
            showStatus(`Starting download: $${filename}`, 'info');
            window.open(downloadUrl, '_blank');
            showStatus(`Download initiated. Files are automatically deleted after 12 hours.`, 'success');
            if (buttonElement) { buttonElement.textContent = 'Downloaded'; buttonElement.style.backgroundColor = '#28a745'; buttonElement.disabled = true; }
        }

        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `status $${type}`;
            uploadStatus.style.display = 'block';
            if (type === 'success' || type === 'error') { setTimeout(() => { uploadStatus.style.display = 'none'; }, 5000); }
        }

        function formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; }

        function clearSession() { uploadedFiles = []; sessionStorage.removeItem('uploadedFiles'); refreshProcessedFiles(); showStatus('Session cleared', 'info'); }

        document.addEventListener('DOMContentLoaded', () => { refreshProcessedFiles(); setInterval(refreshProcessedFiles, 15000); });
    </script>
</body>
</html>

